name: Build Android APK

on:
  push:
    branches: [ main, master, develop ]
    paths: 
      - '**.py'
      - '**.kv'
      - 'buildozer.spec'
      - '**.md'
      - '.github/workflows/**'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # RÄ™czne uruchomienie z GitHub UI
    inputs:
      target:
        description: 'Target platform'
        required: true
        default: 'android'
        type: choice
        options:
        - android
        - android-release

env:
  BUILD_VERSION: 0.1.2  # ZwiÄ™kszaj przy nowych wersjach

jobs:
  build:
    name: Build APK/AAB (Android API 33)
    runs-on: ubuntu-22.04  # Ubuntu 22.04 for compatibility

    strategy:
      matrix:
        arch: [arm64-v8a, armeabi-v7a]  # Tylko te z Twojego spec
      fail-fast: false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Dla tagÃ³w wersji

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

<<<<<<< HEAD
    - name: Install system dependencies (Ubuntu 24.04)
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          openjdk-17-jdk-headless \
          build-essential \
          git \
          zip \
          unzip \
          curl \
          libncurses5-dev \
          libncursesw5-dev \
          libtinfo5 \
          cmake \
          libffi-dev \
          libssl-dev
=======
    - name: Install system dependencies (Ubuntu 22.04)
      run: |
        sudo apt-get update -y
        sudo apt-get install -y --no-install-recommends \
          openjdk-17-jdk-headless \
          build-essential \
          git \
          zip \
          unzip \
          curl \
          cmake \
          libffi-dev \
          libssl-dev \
          python3-dev \
          pkg-config \
          libncurses6 \
          libncursesw6 \
          libtinfo6 \
          zlib1g-dev \
          liblzma-dev \
          libbz2-dev \
          libreadline-dev \
          libsqlite3-dev
>>>>>>> 78f66f04f21de0a2501d9c209ea328c12af18c48

    - name: Cache Python & Buildozer
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          ~/.local
          .buildozer
          .gradle
          ~/.gradle
          ~/.android
          ~/.buildozer_global
          buildozer/.buildozer
        key: ${{ runner.os }}-py3.11-${{ hashFiles('requirements.txt', 'buildozer.spec', 'main.py') }}
        restore-keys: |
          ${{ runner.os }}-py3.11-

    - name: Install Python dependencies
      run: |
<<<<<<< HEAD
        python -m pip install --upgrade pip setuptools wheel Cython==3.0.11
        pip install --only-binary=all buildozer==1.6.1 cython==3.0.11 virtualenv
=======
        python -m pip install --upgrade pip setuptools wheel
        pip install "cython==0.29.34" "virtualenv"
        pip install "buildozer @ git+https://github.com/kivy/buildozer.git@master"
>>>>>>> 78f66f04f21de0a2501d9c209ea328c12af18c48

    - name: Set Buildozer spec versions
      run: |
        # Wstrzyknij dynamicznÄ… wersjÄ™ do buildozer.spec
        sed -i "s/version = 0.1/version = ${BUILD_VERSION}/g" buildozer.spec
        sed -i "s/android.archs = .*/android.archs = ${{ matrix.arch }}/" buildozer.spec
        echo "Updated buildozer.spec:"
        cat buildozer.spec | grep -E "(version|android.archs)"

    - name: Build APK with Buildozer (${{ matrix.arch }})
      id: build
<<<<<<< HEAD
      uses: ArtemSBulgakov/buildozer-action@v1.8.0
      with:
        command: android debug
        workdir: .
        buildozer_version: stable
        buildozer_branch: master
=======
      uses: digreatbrian/buildozer-action@v1
      with:
        buildozer-cmd: buildozer android debug
        python-version: '3.11'
        workdir: .
>>>>>>> 78f66f04f21de0a2501d9c209ea328c12af18c48

    - name: Fix APK filename & permissions
      if: steps.build.outputs.file != ''
      run: |
        APK_FILE=$(ls -t bin/*.apk | head -1)
        if [ -f "$APK_FILE" ]; then
          mv "$APK_FILE" "bin/polskieradiokivy-${{ matrix.arch }}-${{ env.BUILD_VERSION }}.apk"
          chmod 644 "bin/polskieradiokivy-${{ matrix.arch }}-${{ env.BUILD_VERSION }}.apk"
          echo "APK size: $(du -h bin/*.apk | tail -1)"
          echo "APK exists: $APK_FILE"
        fi

    - name: Upload APK artifact
      if: steps.build.outputs.file != ''
      uses: actions/upload-artifact@v4
      with:
        name: polskieradiokivy-${{ matrix.arch }}-${{ env.BUILD_VERSION }}-${{ github.sha_short }}
        path: bin/*.apk
        retention-days: 30
        compression-level: 0

    - name: Upload AAB (Release) if exists
      if: steps.build.outputs.file != '' && contains(github.event.head_commit.message, '[release]')
      uses: actions/upload-artifact@v4
      with:
        name: polskieradiokivy-${{ matrix.arch }}-release-${{ env.BUILD_VERSION }}
        path: bin/*.aab

  universal-apk:
    name: Build Universal APK (combined)
    needs: build
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4

    - name: Download all APKs
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Create Universal APK
      run: |
        mkdir -p bin/universal
        cd artifacts
        # Pobierz APK dla arm64 i armeabi-v7a
        ARM64_APK=$(find . -name "*arm64*apk" | head -1)
        ARMV7A_APK=$(find . -name "*armeabi*apk" | head -1)
        
        if [ -f "$ARM64_APK" ] && [ -f "$ARMV7A_APK" ]; then
          echo "Combining APKs: $ARM64_APK + $ARMV7A_APK"
          VERSION=$(echo $ARM64_APK | grep -o '[0-9].[0-9].[0-9]')
          uber-apk-signer combine-apks \
            --apks $ARM64_APK,$ARMV7A_APK \
            --allowResign \
            --output ./combined/
          
          cp combined/*.apk ../../bin/polskieradiokivy-universal-${VERSION}-debug.apk
          echo "Universal APK created!"
        fi

    - name: Upload Universal APK
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: polskieradiokivy-universal-${{ env.BUILD_VERSION }}
        path: bin/polskieradiokivy-universal-*.apk
        retention-days: 90

  notify:
    name: Notify Results
    needs: [build, universal-apk]
    runs-on: ubuntu-24.04
    if: always()
    steps:
    - name: Summary
      uses: actions/github-script@v7
      with:
        script: |
          const artifacts = await github.rest.actions.listArtifactsForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            per_page: 100
          });
          console.log('âœ… Build finished! Download APKs from Artifacts tab.');
          core.summary.addHeading('ðŸ“± Polskie Radio Kivy APK Build');
          core.summary.addRaw(`**Status:** ${{ needs.build.result }} | **Version:** ${{ env.BUILD_VERSION }}`);
          core.summary.addRaw(`**Archs:** arm64-v8a + armeabi-v7a (universal)`);
          core.summary.addRaw(`**Download:** Actions â†’ Artifacts tab above ðŸ‘†`);
          core.summary.write();